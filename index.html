<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#2b6fff" />
    <title>Wikipedia Link Path Game</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color-scheme: light dark;
        --blue: #2b6fff;
        --green: #34c759;
        --warn: #ff9f0a;
        --border: rgba(0,0,0,.1);
        --border-soft: rgba(0,0,0,.06);
        --bg-soft: color-mix(in srgb, Canvas 92%, transparent);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body { margin: 0; padding: 0; background: Canvas; color: CanvasText; }

      .wrap { display: grid; grid-template-rows: auto 1fr; height: 100vh; }

      header {
        position: sticky; top: 0; z-index: 10;
        padding: 16px clamp(14px, 3vw, 22px);
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(6px);
        background: var(--bg-soft);
        display: flex; flex-direction: column; gap: 14px;
      }

      form { display: flex; flex-direction: column; gap: 12px; }
      .form-group { display: flex; flex-direction: column; gap: 6px; }
      label { font-size: 14px; opacity: .85; }
      .input-row { display: flex; gap: 8px; }
      input[type="url"] {
        flex: 1;
        padding: 14px 14px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,.2);
        font-size: 16px;
        min-height: 44px;
      }
      button {
        padding: 12px 16px;
        border: 0;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        min-height: 44px;
      }
      button.primary { background: var(--blue); color: #fff; }
      button.secondary { background: #eee; color: #000; }
      button.share { background: var(--green); color: #fff; }
      button.warn { background: var(--warn); color: #000; }
      #randomStart, #randomTarget { background: var(--blue) !important; color: #fff !important; }

      .buttons { display: flex; gap: 10px; flex-wrap: wrap; }
      .note { font-size: 13px; opacity: .85; }

      main { display: grid; grid-template-columns: 2fr 1fr; min-height: 0; }
      .articlePane { border-right: 1px solid var(--border); min-height: 0; display: grid; grid-template-rows: auto 1fr; }
      .hud { padding: 12px clamp(14px, 3vw, 22px); display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border-soft); flex-wrap: wrap; }
      .badge { display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 999px; background: #f2f4f8; font-weight: 700; }
      .status { font-size: 15px; opacity: .9; }
      .timer { font-variant-numeric: tabular-nums; }
      .controls { margin-left: auto; display: flex; gap: 8px; }
      .frame { overflow: auto; padding: clamp(10px, 2.5vw, 22px); }
      .frame > .article { max-width: 980px; margin: 0 auto; line-height: 1.55; }
      .article img { max-width: 100%; height: auto; }

      .sidebar { display: grid; grid-template-rows: auto auto auto 1fr; min-height: 0; }
      .panel { padding: 12px clamp(14px, 3vw, 22px); border-bottom: 1px solid var(--border-soft); }
      .list { overflow: auto; padding: 12px clamp(14px, 3vw, 22px); }
      .list ol { margin: 0; padding: 0 0 0 20px; }
      .muted { opacity: .7; }
      .win { background: #e9fbe9; border: 1px solid #b6f0b6; color: #145214; padding: 10px 12px; border-radius: 10px; }
      .err { background: #ffecec; border: 1px solid #ffc4c4; color: #7a0000; padding: 10px 12px; border-radius: 10px; }

      details.steps { border-top: 1px solid var(--border-soft); }
      details.steps > summary {
        list-style: none; cursor: pointer; padding: 12px clamp(14px, 3vw, 22px);
        font-weight: 700;
      }
      details.steps[open] > summary { border-bottom: 1px solid var(--border-soft); }
      details.steps > summary::-webkit-details-marker { display: none; }

      .sidebarDesktop { display: block; }

      /* Mobile drawer */
      .mobileDrawer {
        display: none;
        position: sticky;
        top: calc(56px + 16px);
        z-index: 6;
        background: var(--bg-soft);
        border-bottom: 1px solid var(--border);
      }
      .mobileDrawer summary {
        list-style: none;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .mobileDrawer summary::-webkit-details-marker { display: none; }
      .mobileDrawer .drawerBody {
        padding: 10px 16px 14px 16px;
        display: grid;
        gap: 10px;
      }
      .drawerRow { display: grid; gap: 8px; }
      .drawerButtons { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
      .drawerActions { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
      .drawerControls { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
      .drawerShare { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }

      @media (max-width: 900px) {
        main { grid-template-columns: 1fr; }
        .articlePane { border-right: 0; border-bottom: 1px solid var(--border); }

        .input-row { flex-direction: column; }
        #randomStart, #randomTarget { width: 100%; }
        .buttons { flex-direction: column; }
        .buttons > * { width: 100%; }
        .controls { width: 100%; justify-content: flex-start; }
        .status { font-size: 14px; }
        .badge { padding: 6px 10px; }

        .sidebarDesktop { display: none; }
        .mobileDrawer { display: block; }
      }

      @media (min-width: 1200px) {
        .frame > .article { max-width: 1100px; }
        .hud { gap: 16px; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <form id="setup">
          <div class="form-group">
            <label for="startUrl">Start article URL</label>
            <div class="input-row">
              <input id="startUrl" type="url" placeholder="https://en.wikipedia.org/wiki/Cat" required />
              <button type="button" id="randomStart">Random</button>
            </div>
          </div>
          <div class="form-group">
            <label for="targetUrl">Target article URL</label>
            <div class="input-row">
              <input id="targetUrl" type="url" placeholder="https://en.wikipedia.org/wiki/Quantum_mechanics" required />
              <button type="button" id="randomTarget">Random</button>
            </div>
          </div>
          <div class="buttons">
            <button class="primary" id="begin" type="submit">Start game</button>
            <button class="secondary" id="reset" type="button">Reset</button>
          </div>
        </form>
        <div class="note">Use Random or paste links. Timer during play. Undo. Restart. Share link. Copy route.</div>

        <details id="mobileDrawer" class="mobileDrawer" open>
          <summary aria-controls="drawerBody" aria-expanded="true">
            Game controls
            <span id="drawerChevron" aria-hidden="true">▾</span>
          </summary>
          <div class="drawerBody" id="drawerBody">
            <div class="drawerRow">
              <strong>Goal</strong>
              <div class="muted">Navigate from <span id="goalFrom_m">None</span> to <span id="goalTo_m">None</span></div>
            </div>

            <div class="drawerButtons">
              <button id="undoBtn_m" class="secondary">Undo</button>
              <button id="restartBtn_m" class="warn">Restart</button>
            </div>

            <div class="drawerShare">
              <button id="shareResultsBtn_m" class="share">Copy path text</button>
              <button id="shareLinkBtn_m" class="primary">Copy share link</button>
            </div>

            <div class="drawerRow">
              <details id="stepsWrap_m" open>
                <summary><strong>Steps</strong></summary>
                <div class="list"><ol id="steps_m"></ol></div>
              </details>
            </div>
          </div>
        </details>
      </header>

      <main>
        <section class="articlePane">
          <div class="hud">
            <div class="badge" id="clickCount">0</div>
            <div class="status"><span class="muted">Current</span> <span id="currentTitle">None</span></div>
            <div class="status">Time <span class="timer" id="timer">00:00</span></div>
            <div class="controls">
              <button id="undoBtn" class="secondary">Undo</button>
              <button id="restartBtn" class="warn">Restart</button>
            </div>
          </div>
          <div class="frame" id="frame">
            <div class="article" id="article"><p class="muted">Enter two Wikipedia links above and press Start game.</p></div>
          </div>
        </section>

        <aside class="sidebar sidebarDesktop">
          <div class="panel">
            <div><strong>Goal</strong></div>
            <div class="muted">Navigate from <span id="goalFrom"></span> to <span id="goalTo"></span></div>
          </div>
          <div class="panel" id="msg"></div>
          <div class="panel" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="shareResultsBtn" class="share">Copy path text</button>
            <button id="shareLinkBtn" class="primary">Copy share link</button>
          </div>
          <details class="steps" open>
            <summary>Steps</summary>
            <div class="list">
              <ol id="steps"></ol>
            </div>
          </details>
        </aside>
      </main>
    </div>

    <script>
      const W_API = "https://en.wikipedia.org/w/api.php";

      const els = {
        setup: document.getElementById('setup'),
        startUrl: document.getElementById('startUrl'),
        targetUrl: document.getElementById('targetUrl'),
        randomStart: document.getElementById('randomStart'),
        randomTarget: document.getElementById('randomTarget'),

        article: document.getElementById('article'),
        steps: document.getElementById('steps'),
        steps_m: document.getElementById('steps_m'),

        clickCount: document.getElementById('clickCount'),
        currentTitle: document.getElementById('currentTitle'),
        goalFrom: document.getElementById('goalFrom'),
        goalTo: document.getElementById('goalTo'),
        goalFrom_m: document.getElementById('goalFrom_m'),
        goalTo_m: document.getElementById('goalTo_m'),

        msg: document.getElementById('msg'),
        timer: document.getElementById('timer'),
        undoBtn: document.getElementById('undoBtn'),
        restartBtn: document.getElementById('restartBtn'),
        shareResultsBtn: document.getElementById('shareResultsBtn'),
        shareLinkBtn: document.getElementById('shareLinkBtn'),

        drawer: document.getElementById('mobileDrawer'),
        drawerChevron: document.getElementById('drawerChevron'),
        undoBtn_m: document.getElementById('undoBtn_m'),
        restartBtn_m: document.getElementById('restartBtn_m'),
        shareResultsBtn_m: document.getElementById('shareResultsBtn_m'),
        shareLinkBtn_m: document.getElementById('shareLinkBtn_m')
      };

      let state = {
        playing: false,
        originTitle: null,
        targetTitle: null,
        currentTitle: null,
        count: 0,
        path: [],
        startTime: null,
        timerId: null
      };

      function wikiTitleFromUrl(url) {
        try {
          const u = new URL(url);
          if (u.hostname.endsWith('wikipedia.org')) {
            const parts = u.pathname.split('/');
            const idx = parts.indexOf('wiki');
            if (idx !== -1 && parts[idx+1]) {
              return decodeURIComponent(parts.slice(idx+1).join('/'));
            }
          }
        } catch {}
        return null;
      }

      function wikiUrlFromTitle(title) {
        const t = encodeURIComponent(title.replace(/\s/g, '_'));
        return `https://en.wikipedia.org/wiki/${t}`;
      }

      function normalizeTitle(title) {
        if (!title) return null;
        const t = title.replace(/_/g, ' ').trim();
        return t.charAt(0).toUpperCase() + t.slice(1);
      }

      function setMessage(html, kind = '') {
        els.msg.innerHTML = html || '';
        els.msg.className = 'panel ' + kind;
      }

      function resetGame(keepTargets = true) {
        stopTimer();
        const keepOrigin = keepTargets ? state.originTitle : null;
        const keepTarget = keepTargets ? state.targetTitle : null;
        state = { playing: false, originTitle: keepOrigin, targetTitle: keepTarget, currentTitle: null, count: 0, path: [], startTime: null, timerId: null };
        els.clickCount.textContent = '0';
        els.steps.innerHTML = '';
        els.steps_m.innerHTML = '';
        els.article.innerHTML = '<p class="muted">Enter two Wikipedia links above and press Start game.</p>';
        els.currentTitle.textContent = 'None';
        els.timer.textContent = '00:00';
        if (!keepTargets) {
          els.goalFrom.textContent = '';
          els.goalTo.textContent = '';
          els.goalFrom_m.textContent = 'None';
          els.goalTo_m.textContent = 'None';
        }
        setMessage('');
      }

      function startTimer() {
        state.startTime = Date.now();
        state.timerId = setInterval(() => {
          const s = Math.floor((Date.now() - state.startTime) / 1000);
          const mm = String(Math.floor(s / 60)).padStart(2,'0');
          const ss = String(s % 60).padStart(2,'0');
          els.timer.textContent = `${mm}:${ss}`;
        }, 250);
      }

      function stopTimer() {
        if (state.timerId) {
          clearInterval(state.timerId);
          state.timerId = null;
        }
      }

      async function loadArticle(title, increment = false, pushIfFirst = true) {
        const norm = normalizeTitle(title);
        const url = `${W_API}?action=parse&format=json&origin=*&prop=text&page=${encodeURIComponent(norm)}`;
        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('Request failed');
          const data = await res.json();
          if (!data.parse || !data.parse.text || !data.parse.text['*']) throw new Error('Article not found');

          const html = data.parse.text['*'];
          els.article.innerHTML = html;

          const pageTitle = data.parse.title || norm;
          state.currentTitle = pageTitle;
          els.currentTitle.textContent = pageTitle;

          const base = new URL('https://en.wikipedia.org');
          els.article.querySelectorAll('a[href]').forEach(a => {
            const href = a.getAttribute('href');
            if (!href) return;
            if (href.startsWith('/wiki/')) {
              a.setAttribute('data-wiki-title', decodeURIComponent(href.replace(/^\/wiki\//, '')));
            } else if (href.startsWith('#')) {
            } else {
              a.setAttribute('target', '_blank');
              a.setAttribute('rel', 'noopener');
            }
          });
          els.article.querySelectorAll('img[src]').forEach(img => {
            try {
              const src = img.getAttribute('src');
              const abs = new URL(src, base);
              img.src = abs.href;
            } catch {}
          });

          if (!increment && pushIfFirst && state.path.length === 0) {
            state.path.push({ title: pageTitle, url: wikiUrlFromTitle(pageTitle) });
            renderPath();
          }

          if (state.playing && normalizeTitle(pageTitle) === normalizeTitle(state.targetTitle)) {
            setMessage(`<div class="win"><strong>You made it</strong> in ${state.count} clicks and ${els.timer.textContent} time.</div>`);
            stopTimer();
            state.playing = false;
          } else if (state.playing) {
            setMessage('');
          }
        } catch (err) {
          setMessage(`<div class="err">Could not load article. Please check the title and try again.</div>`);
        }
      }

      function renderPath() {
        els.steps.innerHTML = '';
        els.steps_m.innerHTML = '';
        state.path.forEach(step => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = step.url; a.textContent = step.title; a.target = '_blank'; a.rel = 'noopener';
          li.appendChild(a);
          els.steps.appendChild(li.cloneNode(true));
          els.steps_m.appendChild(li);
        });
        els.clickCount.textContent = String(state.count);
      }

      async function startGameByTitles(startTitle, targetTitle) {
        resetGame(true);
        state.originTitle = startTitle;
        state.targetTitle = targetTitle;
        state.playing = true;
        const fromNorm = normalizeTitle(startTitle);
        const toNorm = normalizeTitle(targetTitle);
        els.goalFrom.textContent = fromNorm;
        els.goalTo.textContent = toNorm;
        els.goalFrom_m.textContent = fromNorm;
        els.goalTo_m.textContent = toNorm;
        startTimer();
        await loadArticle(startTitle, false, true);
      }

      els.article.addEventListener('click', async (e) => {
        const a = e.target.closest('a');
        if (!a) return;
        const t = a.getAttribute('data-wiki-title');
        if (t) {
          e.preventDefault();
          if (!state.playing) return;
          state.count += 1;
          const nextTitle = decodeURIComponent(t);
          state.path.push({ title: normalizeTitle(nextTitle), url: wikiUrlFromTitle(nextTitle) });
          renderPath();
          await loadArticle(nextTitle, true, false);
        }
      });

      els.setup.addEventListener('submit', async (e) => {
        e.preventDefault();
        const startTitle = wikiTitleFromUrl(els.startUrl.value);
        const targetTitle = wikiTitleFromUrl(els.targetUrl.value);
        if (!startTitle || !targetTitle) {
          setMessage('<div class="err">Please enter valid Wikipedia article links that contain /wiki/ in the path.</div>');
          return;
        }
        els.startUrl.value  = wikiUrlFromTitle(startTitle);
        els.targetUrl.value = wikiUrlFromTitle(targetTitle);
        await startGameByTitles(startTitle, targetTitle);
      });

      function wireMirrorButtons(srcBtn, destBtn) {
        const click = new Event('click', { bubbles: true });
        srcBtn.addEventListener('click', () => destBtn.dispatchEvent(click));
      }

      // desktop buttons
      els.undoBtn.addEventListener('click', async () => {
        if (!state.playing || state.path.length <= 1) return;
        state.path.pop();
        state.count = Math.max(0, state.count - 1);
        const last = state.path[state.path.length - 1];
        renderPath();
        await loadArticle(last.title, false, false);
      });

      els.restartBtn.addEventListener('click', async () => {
        if (!state.originTitle || !state.targetTitle) return;
        await startGameByTitles(state.originTitle, state.targetTitle);
      });

      els.shareResultsBtn.addEventListener('click', () => {
        if (!state.path.length) { setMessage('<div class="err">No results to copy yet.</div>'); return; }
        const text = `Wikipedia Link Path Game Result\n\nFrom: ${normalizeTitle(state.originTitle)}\nTo: ${normalizeTitle(state.targetTitle)}\nClicks: ${state.count}\nTime: ${els.timer.textContent}\n\nPath:\n${state.path.map((s,i)=>`${i+1}. ${s.title} -> ${s.url}`).join('\n')}`;
        navigator.clipboard.writeText(text).then(() => {
          setMessage('<div class="win">Copied path text to clipboard.</div>');
        }).catch(() => { setMessage('<div class="err">Clipboard copy failed.</div>'); });
      });

      els.shareLinkBtn.addEventListener('click', () => {
        const startTitle = state.originTitle || wikiTitleFromUrl(els.startUrl.value);
        const targetTitle = state.targetTitle || wikiTitleFromUrl(els.targetUrl.value);
        if (!startTitle || !targetTitle) { setMessage('<div class="err">Provide start and target first.</div>'); return; }
        const url = new URL(location.href);
        url.searchParams.set('start', startTitle);
        url.searchParams.set('target', targetTitle);
        navigator.clipboard.writeText(url.toString()).then(() => {
          setMessage('<div class="win">Copied share link to clipboard.</div>');
        }).catch(() => { setMessage('<div class="err">Clipboard copy failed.</div>'); });
      });

      // mobile mirrored buttons
      wireMirrorButtons(els.undoBtn_m, els.undoBtn);
      wireMirrorButtons(els.restartBtn_m, els.restartBtn);
      wireMirrorButtons(els.shareResultsBtn_m, els.shareResultsBtn);
      wireMirrorButtons(els.shareLinkBtn_m, els.shareLinkBtn);

      async function getRandomArticleUrl() {
        try {
          const res = await fetch(`${W_API}?action=query&format=json&origin=*&list=random&rnnamespace=0&rnlimit=1`);
          if (!res.ok) throw new Error('random fetch failed');
          const data = await res.json();
          const title = data?.query?.random?.[0]?.title;
          if (!title) throw new Error('no title');
          return `https://en.wikipedia.org/wiki/${encodeURIComponent(title.replace(/ /g, '_'))}`;
        } catch {
          setMessage('<div class="err">Could not fetch a random article. Try again.</div>');
          return null;
        }
      }

      els.randomStart.addEventListener('click', async () => {
        const url = await getRandomArticleUrl();
        if (url) els.startUrl.value = url;
      });

      els.randomTarget.addEventListener('click', async () => {
        const url = await getRandomArticleUrl();
        if (url) els.targetUrl.value = url;
      });

      function tryAutoStartFromQuery() {
        const params = new URLSearchParams(location.search);
        const startQ = params.get('start');
        const targetQ = params.get('target');
        if (startQ && targetQ) {
          const sUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(startQ)}`;
          const tUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(targetQ)}`;
          els.startUrl.value = sUrl;
          els.targetUrl.value = tUrl;
          startGameByTitles(startQ, targetQ);
        }
      }

      // mobile drawer behavior
      function updateChevron() {
        const open = els.drawer.open;
        els.drawerChevron.textContent = open ? '▾' : '▸';
        const summary = els.drawer.querySelector('summary');
        summary.setAttribute('aria-expanded', open ? 'true' : 'false');
      }
      els.drawer.addEventListener('toggle', updateChevron);

      let collapseTimer = null;
      function scheduleAutoCollapse() {
        if (window.matchMedia('(max-width: 900px)').matches) {
          if (collapseTimer) clearTimeout(collapseTimer);
          collapseTimer = setTimeout(() => {
            els.drawer.open = false;
            updateChevron();
          }, 2500);
        }
      }
      scheduleAutoCollapse();

      let scrolled = false;
      window.addEventListener('scroll', () => {
        if (scrolled) return;
        scrolled = true;
        if (window.matchMedia('(max-width: 900px)').matches) {
          els.drawer.open = false;
          updateChevron();
        }
      }, { passive: true });

      tryAutoStartFromQuery();
    </script>
  </body>
</html>
