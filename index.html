<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#2b6fff" />
    <title>Wikipedia Link Path Game</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color-scheme: light dark;
        --blue: #2b6fff;
        --green: #34c759;
        --warn: #ff9f0a;
        --border: rgba(0,0,0,.12);
        --border-soft: rgba(0,0,0,.08);
        --bg-soft: color-mix(in srgb, Canvas 92%, transparent);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body { margin: 0; padding: 0; background: Canvas; color: CanvasText; }
      a { color: LinkText; }

      .wrap { display: grid; grid-template-rows: auto 1fr; height: 100vh; }

      header {
        position: sticky; top: 0; z-index: 20;
        padding: 12px clamp(14px, 3vw, 22px);
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(6px);
        background: var(--bg-soft);
        display: flex; flex-direction: column; gap: 12px;
      }

      /* single controls drawer used on all sizes to avoid duplicates */
      .mobileDrawer {
        display: block;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,.06);
        overflow: hidden;
      }
      .mobileDrawer[open] { border-color: var(--border-soft); }
      .mobileDrawer summary {
        list-style: none;
        padding: 12px 16px;
        font-weight: 800;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .mobileDrawer summary::-webkit-details-marker { display: none; }
      .mobileDrawer .drawerBody {
        padding: 10px 16px 16px 16px;
        display: grid;
        gap: 12px;
      }

      .form-group { display: flex; flex-direction: column; gap: 6px; }
      label { font-size: 14px; opacity: .85; }
      .input-row { display: flex; gap: 8px; }
      input[type="url"] {
        flex: 1;
        padding: 14px 14px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,.2);
        font-size: 16px;
        min-height: 44px;
      }
      button {
        padding: 12px 16px;
        border: 0;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        min-height: 44px;
      }
      button.primary { background: var(--blue); color: #fff; }
      button.secondary { background: #eee; color: #000; }
      button.share { background: var(--green); color: #fff; }
      button.warn { background: var(--warn); color: #000; }
      #randomStart, #randomTarget { background: var(--blue); color: #fff; }

      .buttons { display: flex; gap: 10px; flex-wrap: wrap; }

      main { display: grid; grid-template-columns: 3fr 1fr; min-height: 0; }
      @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }

      .articlePane { border-right: 1px solid var(--border); min-height: 0; display: grid; grid-template-rows: auto 1fr; }
      @media (max-width: 1024px) { .articlePane { border-right: 0; border-bottom: 1px solid var(--border); } }

      .hud {
        padding: 12px clamp(14px, 3vw, 22px);
        display: flex; align-items: center; gap: 12px;
        border-bottom: 1px solid var(--border-soft); flex-wrap: wrap;
      }
      .badge { display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 999px; background: #f2f4f8; font-weight: 700; }
      .status { font-size: 15px; opacity: .9; }
      .timer { font-variant-numeric: tabular-nums; }
      .controls { margin-left: auto; display: flex; gap: 8px; }

      .frame { overflow: auto; padding: clamp(10px, 2.5vw, 22px); }
      .frame > .article { max-width: 980px; margin: 0 auto; line-height: 1.55; }
      .article img { max-width: 100%; height: auto; }

      .sidebar { display: grid; grid-template-rows: auto auto 1fr; min-height: 0; }
      .panel { padding: 12px clamp(14px, 3vw, 22px); border-bottom: 1px solid var(--border-soft); }
      .list { overflow: auto; padding: 12px clamp(14px, 3vw, 22px); }
      .list ol { margin: 0; padding: 0 0 0 20px; }
      .muted { opacity: .7; }
      .win { background: #e9fbe9; border: 1px solid #b6f0b6; color: #145214; padding: 10px 12px; border-radius: 10px; }
      .err { background: #ffecec; border: 1px solid #ffc4c4; color: #7a0000; padding: 10px 12px; }

      details.steps { border-top: 1px solid var(--border-soft); }
      details.steps > summary {
        list-style: none; cursor: pointer; padding: 12px clamp(14px, 3vw, 22px);
        font-weight: 700;
      }
      details.steps[open] > summary { border-bottom: 1px solid var(--border-soft); }
      details.steps > summary::-webkit-details-marker { display: none; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <details id="controls" class="mobileDrawer" open>
          <summary>Game controls <span id="drawerChevron" aria-hidden="true">▾</span></summary>
          <div class="drawerBody">
            <div class="form-group">
              <label for="startUrl">Start article URL or title</label>
              <div class="input-row">
                <input id="startUrl" type="url" placeholder="https://en.wikipedia.org/wiki/Cat or Cat" />
                <button type="button" id="randomStart">Random</button>
              </div>
            </div>
            <div class="form-group">
              <label for="targetUrl">Target article URL or title</label>
              <div class="input-row">
                <input id="targetUrl" type="url" placeholder="https://en.wikipedia.org/wiki/Quantum_mechanics or Quantum mechanics" />
                <button type="button" id="randomTarget">Random</button>
              </div>
            </div>
            <div class="buttons">
              <button class="primary" id="begin" type="button">Start game</button>
              <button class="secondary" id="reset" type="button">Reset</button>
              <button class="secondary" id="undoBtn" type="button">Undo</button>
              <button class="warn" id="restartBtn" type="button">Restart</button>
              <button class="share" id="shareResultsBtn" type="button">Copy path text</button>
              <button class="primary" id="shareLinkBtn" type="button">Copy share link</button>
            </div>
          </div>
        </details>
      </header>

      <main>
        <section class="articlePane">
          <div class="hud">
            <div class="badge" id="clickCount">0</div>
            <div class="status"><span class="muted">Current</span> <span id="currentTitle">None</span></div>
            <div class="status">Time <span class="timer" id="timer">00:00</span></div>
          </div>
          <div class="frame" id="frame">
            <div class="article" id="article"><p class="muted">Enter two Wikipedia links or titles and press Start game.</p></div>
          </div>
        </section>

        <aside class="sidebar">
          <div class="panel" id="msg"></div>
          <details class="steps" open>
            <summary>Steps</summary>
            <div class="list"><ol id="steps"></ol></div>
          </details>
        </aside>
      </main>
    </div>

    <script>
      const W_API = "https://en.wikipedia.org/w/api.php";

      const els = {
        controls: document.getElementById('controls'),
        drawerChevron: document.getElementById('drawerChevron'),

        startUrl: document.getElementById('startUrl'),
        targetUrl: document.getElementById('targetUrl'),
        randomStart: document.getElementById('randomStart'),
        randomTarget: document.getElementById('randomTarget'),
        begin: document.getElementById('begin'),
        reset: document.getElementById('reset'),

        article: document.getElementById('article'),
        steps: document.getElementById('steps'),
        clickCount: document.getElementById('clickCount'),
        currentTitle: document.getElementById('currentTitle'),
        msg: document.getElementById('msg'),
        timer: document.getElementById('timer'),

        undoBtn: document.getElementById('undoBtn'),
        restartBtn: document.getElementById('restartBtn'),
        shareResultsBtn: document.getElementById('shareResultsBtn'),
        shareLinkBtn: document.getElementById('shareLinkBtn')
      };

      let state = { playing:false, originTitle:null, targetTitle:null, currentTitle:null, count:0, path:[], startTime:null, timerId:null };

      function updateChevron(){ els.drawerChevron.textContent = els.controls.open ? '▾' : '▸'; }
      els.controls.addEventListener('toggle', updateChevron); updateChevron();

      function ensureWikiUrlOrTitle(input) {
        if (!input) return null;
        try {
          const u = new URL(input);
          if (u.hostname.endsWith('wikipedia.org') && u.pathname.includes('/wiki/')) return u.toString();
        } catch {}
        return wikiUrlFromTitle(input);
      }

      function wikiTitleFromUrl(url){
        try{
          const u=new URL(url);
          if(u.hostname.endsWith('wikipedia.org')){
            const p=u.pathname.split('/');
            const i=p.indexOf('wiki');
            if(i!==-1&&p[i+1]) return decodeURIComponent(p.slice(i+1).join('/'));
          }
        }catch{}
        return null;
      }

      function wikiUrlFromTitle(t){
        const withUnderscores = t.replace(/\s/g,'_');
        return `https://en.wikipedia.org/wiki/${encodeURIComponent(withUnderscores)}`;
      }

      function normalizeTitle(t){
        if(!t) return null;
        const x=t.replace(/_/g,' ').trim();
        return x.charAt(0).toUpperCase()+x.slice(1);
      }

      function setMessage(h,k=''){ els.msg.innerHTML=h||''; els.msg.className='panel '+k; }

      function startTimer(){
        state.startTime=Date.now();
        state.timerId=setInterval(()=>{
          const s=Math.floor((Date.now()-state.startTime)/1000);
          const m=String(Math.floor(s/60)).padStart(2,'0');
          const ss=String(s%60).padStart(2,'0');
          els.timer.textContent=`${m}:${ss}`;
        },250);
      }
      function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }

      async function loadArticle(t){
        const n=normalizeTitle(t);
        try{
          const r=await fetch(`${W_API}?action=parse&format=json&origin=*&prop=text&page=${encodeURIComponent(n)}&redirects=`);
          if(!r.ok) throw new Error('request failed');
          const d=await r.json();
          if(!d.parse || !d.parse.text || !d.parse.text['*']) throw new Error('no parse');
          const html=d.parse.text['*'];
          els.article.innerHTML=html;
          const pageTitle=d.parse.title||n;
          state.currentTitle=pageTitle;
          els.currentTitle.textContent=pageTitle;

          // convert in article links
          const base = new URL('https://en.wikipedia.org');
          els.article.querySelectorAll('a[href]').forEach(a=>{
            const href=a.getAttribute('href');
            if(!href) return;
            if(href.startsWith('/wiki/')){
              a.setAttribute('data-wiki-title', decodeURIComponent(href.replace(/^\/wiki\//,'')));
            } else if (href.startsWith('#')) {
            } else {
              a.setAttribute('target','_blank'); a.setAttribute('rel','noopener');
              try { a.href = new URL(href, base).href; } catch {}
            }
          });

          if(state.playing && normalizeTitle(pageTitle)===normalizeTitle(state.targetTitle)){
            setMessage(`<div class="win">You made it in ${state.count} clicks and ${els.timer.textContent}</div>`);
            stopTimer();
            state.playing=false;
          } else if (state.playing){
            setMessage('');
          }
        }catch(err){
          setMessage('<div class="err">Could not load article. Check titles and try again.</div>');
        }
      }

      function resetGame(clearTargets=false){
        stopTimer();
        const keepStart = clearTargets ? null : state.originTitle;
        const keepTarget = clearTargets ? null : state.targetTitle;
        state={playing:false,originTitle:keepStart,targetTitle:keepTarget,currentTitle:null,count:0,path:[],startTime:null,timerId:null};
        els.clickCount.textContent='0';
        els.steps.innerHTML='';
        els.article.innerHTML='<p class="muted">Enter two Wikipedia links or titles and press Start game.</p>';
        els.currentTitle.textContent='None';
        els.timer.textContent='00:00';
        setMessage('');
      }

      function renderPath(){
        els.steps.innerHTML='';
        state.path.forEach(step=>{
          const li=document.createElement('li');
          const a=document.createElement('a');
          a.href=step.url; a.textContent=step.title; a.target='_blank'; a.rel='noopener';
          li.appendChild(a);
          els.steps.appendChild(li);
        });
        els.clickCount.textContent=String(state.count);
      }

      async function startByInputs(sInput,tInput){
        const sUrl = ensureWikiUrlOrTitle(sInput);
        const tUrl = ensureWikiUrlOrTitle(tInput);
        const st = wikiTitleFromUrl(sUrl);
        const tt = wikiTitleFromUrl(tUrl);
        if(!st || !tt){
          setMessage('<div class="err">Enter valid Wikipedia links or titles.</div>');
          return;
        }
        resetGame(false);
        state.originTitle=st;
        state.targetTitle=tt;
        state.path=[{title:normalizeTitle(st),url:wikiUrlFromTitle(st)}];
        state.count=0;
        state.playing=true;
        startTimer();
        await loadArticle(st);
      }

      els.begin.addEventListener('click',()=>startByInputs(els.startUrl.value, els.targetUrl.value));
      els.reset.addEventListener('click',()=>resetGame(false));

      els.article.addEventListener('click',async e=>{
        const a=e.target.closest('a'); if(!a) return;
        const t=a.getAttribute('data-wiki-title'); if(!t) return;
        e.preventDefault();
        if(!state.playing) return;
        state.count+=1;
        state.path.push({title:normalizeTitle(t),url:wikiUrlFromTitle(t)});
        renderPath();
        await loadArticle(t);
      });

      async function getRandomArticleUrl(){
        try{
          const r=await fetch(`${W_API}?action=query&format=json&origin=*&list=random&rnnamespace=0&rnlimit=1`);
          if(!r.ok) throw new Error('random failed');
          const d=await r.json();
          const title=d?.query?.random?.[0]?.title;
          if(!title) throw new Error('no title');
          return `https://en.wikipedia.org/wiki/${encodeURIComponent(title.replace(/ /g,'_'))}`;
        }catch{ return null; }
      }
      async function setRandom(el){
        const u=await getRandomArticleUrl();
        if(u){ el.value=u; }
      }
      els.randomStart.addEventListener('click',()=>setRandom(els.startUrl));
      els.randomTarget.addEventListener('click',()=>setRandom(els.targetUrl));

      function copyResults(){
        if(!state.path.length){ setMessage('<div class="err">No results yet.</div>'); return; }
        const start=normalizeTitle(state.originTitle);
        const target=normalizeTitle(state.targetTitle);
        const challengeUrl=new URL(location.href);
        challengeUrl.searchParams.set('start', state.originTitle);
        challengeUrl.searchParams.set('target', state.targetTitle);
        const text=`Wikipedia Link Path Game Result

From: ${start}
To: ${target}
Clicks: ${state.count}
Time: ${els.timer.textContent}

Path:
${state.path.map((s,i)=>`${i+1}. ${s.title} -> ${s.url}`).join('\n')}

Challenge your friends:
${challengeUrl.toString()}`;
        navigator.clipboard.writeText(text)
          .then(()=>setMessage('<div class="win">Copied path and challenge link.</div>'))
          .catch(()=>setMessage('<div class="err">Clipboard copy failed.</div>'));
      }
      function copyShareLink(){
        const st=state.originTitle || wikiTitleFromUrl(ensureWikiUrlOrTitle(els.startUrl.value));
        const tt=state.targetTitle || wikiTitleFromUrl(ensureWikiUrlOrTitle(els.targetUrl.value));
        if(!st || !tt){ setMessage('<div class="err">Provide start and target first.</div>'); return; }
        const u=new URL(location.href); u.searchParams.set('start',st); u.searchParams.set('target',tt);
        navigator.clipboard.writeText(u.toString())
          .then(()=>setMessage('<div class="win">Copied challenge link.</div>'))
          .catch(()=>setMessage('<div class="err">Clipboard copy failed.</div>'));
      }
      els.shareResultsBtn.addEventListener('click',copyResults);
      els.shareLinkBtn.addEventListener('click',copyShareLink);

      async function undo(){
        if(!state.playing || state.path.length<=1) return;
        state.path.pop();
        state.count=Math.max(0,state.count-1);
        const last=state.path[state.path.length-1];
        renderPath();
        await loadArticle(last.title);
      }
      async function restart(){
        if(!state.originTitle || !state.targetTitle) return;
        state.count=0;
        state.path=[{title:normalizeTitle(state.originTitle),url:wikiUrlFromTitle(state.originTitle)}];
        startTimer();
        await loadArticle(state.originTitle);
      }
      els.undoBtn.addEventListener('click',undo);
      els.restartBtn.addEventListener('click',restart);

      (function autoStartFromQuery(){
        const p=new URLSearchParams(location.search);
        const sRaw=p.get('start');
        const tRaw=p.get('target');
        if(sRaw && tRaw){
          const sUrl = ensureWikiUrlOrTitle(sRaw);
          const tUrl = ensureWikiUrlOrTitle(tRaw);
          els.startUrl.value = sUrl;
          els.targetUrl.value = tUrl;
          startByInputs(sRaw, tRaw);
        }
      })();
    </script>
  </body>
</html>
